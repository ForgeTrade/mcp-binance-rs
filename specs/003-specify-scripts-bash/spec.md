# Feature Specification: HTTP REST API + WebSocket для Binance

**Feature Branch**: `003-http-websocket-api`
**Created**: 2025-10-16
**Status**: Draft
**Input**: User description: "HTTP REST API + WebSocket для биржевых данных Binance с двухуровневой аутентификацией"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Получение рыночных данных через REST API (Priority: P1)

Трейдер хочет получить текущие цены, исторические данные и информацию о рынке через простые HTTP запросы для анализа и принятия торговых решений.

**Why this priority**: Это базовая функциональность для любого трейдера. Без доступа к рыночным данным невозможно принимать торговые решения. REST API идеален для разовых запросов и интеграции с аналитическими инструментами.

**Independent Test**: Можно полностью протестировать отправив GET запрос к `/api/v1/ticker/price?symbol=BTCUSDT` и получив текущую цену. Доставляет немедленную ценность - доступ к биржевым данным без необходимости работать со stdio MCP протоколом.

**Acceptance Scenarios**:

1. **Given** пользователь имеет валидный API токен сервера, **When** делает GET запрос `/api/v1/ticker/price?symbol=BTCUSDT`, **Then** получает JSON ответ с текущей ценой и timestamp в течение 1 секунды
2. **Given** пользователь запрашивает исторические данные, **When** делает GET запрос `/api/v1/klines?symbol=BTCUSDT&interval=1h&limit=100`, **Then** получает массив из 100 свечей с OHLCV данными
3. **Given** указан невалидный символ, **When** делает запрос с `symbol=INVALID`, **Then** получает HTTP 400 ошибку с описанием проблемы
4. **Given** пользователь не авторизован, **When** делает запрос без Authorization header, **Then** получает HTTP 401 ошибку

---

### User Story 2 - Управление ордерами через REST API (Priority: P1)

Трейдер хочет размещать, отменять и проверять статус своих ордеров через HTTP API для автоматизации торговой стратегии.

**Why this priority**: Критичная функциональность для активной торговли. Трейдеры должны иметь возможность быстро реагировать на рыночные условия, размещая и отменяя ордера.

**Independent Test**: Можно протестировать создав лимитный ордер через POST `/api/v1/order` с параметрами и проверив его создание. Доставляет полную ценность - возможность торговать программно через HTTP API.

**Acceptance Scenarios**:

1. **Given** пользователь авторизован и имеет Binance credentials, **When** отправляет POST `/api/v1/order` с параметрами лимитного ордера, **Then** получает подтверждение с order ID и статусом "NEW"
2. **Given** существует активный ордер, **When** отправляет DELETE `/api/v1/order?symbol=BTCUSDT&orderId=12345`, **Then** ордер отменяется и возвращается статус "CANCELED"
3. **Given** недостаточно средств на балансе, **When** пытается создать ордер, **Then** получает HTTP 400 с ошибкой "Insufficient balance"
4. **Given** пользователь запрашивает статус ордера, **When** делает GET `/api/v1/order?symbol=BTCUSDT&orderId=12345`, **Then** получает актуальный статус и детали ордера

---

### User Story 3 - Получение баланса и позиций (Priority: P1)

Трейдер хочет видеть свой текущий баланс и открытые позиции для контроля рисков и управления капиталом.

**Why this priority**: Необходимо для риск-менеджмента. Трейдеры должны знать свой доступный капитал перед открытием позиций.

**Independent Test**: Можно протестировать запросив GET `/api/v1/account` и получив баланс всех активов. Доставляет ценность - видимость капитала и позиций.

**Acceptance Scenarios**:

1. **Given** пользователь авторизован, **When** делает GET `/api/v1/account`, **Then** получает список всех балансов с доступными и заблокированными средствами
2. **Given** у пользователя есть открытые позиции, **When** делает GET `/api/v1/positions`, **Then** получает список всех открытых позиций с P&L
3. **Given** баланс изменился после торговли, **When** повторно запрашивает баланс, **Then** видит актуальные значения

---

### User Story 4 - Реалтайм цены через WebSocket (Priority: P2)

Трейдер хочет получать обновления цен в реальном времени без постоянного polling для быстрой реакции на рыночные изменения.

**Why this priority**: Важно для активных трейдеров, но не блокирует базовую функциональность. WebSocket предоставляет низколатентный доступ к данным, критичный для скальпинга и арбитража.

**Independent Test**: Можно протестировать подключившись к WebSocket `/ws/ticker/btcusdt` и получая обновления цены каждые 100-1000мс. Доставляет ценность - реалтайм мониторинг без нагрузки на REST API.

**Acceptance Scenarios**:

1. **Given** пользователь подключается к WebSocket `/ws/ticker/btcusdt`, **When** устанавливается соединение, **Then** начинает получать JSON сообщения с обновлениями цены
2. **Given** цена изменилась на Binance, **When** происходит изменение, **Then** клиент получает обновление в течение 500мс
3. **Given** соединение разорвано, **When** клиент пытается переподключиться, **Then** WebSocket автоматически восстанавливает соединение
4. **Given** подписка на несколько символов, **When** клиент отправляет subscribe сообщение, **Then** начинает получать данные по всем запрошенным символам

---

### User Story 5 - Реалтайм Order Book через WebSocket (Priority: P2)

Трейдер хочет видеть обновления стакана ордеров в реальном времени для анализа ликвидности и определения точек входа/выхода.

**Why this priority**: Критично для market making и высокочастотной торговли, но не для базовых сценариев.

**Independent Test**: Можно протестировать подключившись к `/ws/depth/btcusdt` и получая обновления bid/ask. Доставляет ценность - глубокое понимание рыночной микроструктуры.

**Acceptance Scenarios**:

1. **Given** подключение к `/ws/depth/btcusdt`, **When** соединение установлено, **Then** получает полный snapshot стакана с топ-20 bid/ask уровнями
2. **Given** ордер размещен или отменен, **When** стакан изменился, **Then** клиент получает инкрементальное обновление с изменениями
3. **Given** высокая волатильность, **When** стакан обновляется часто, **Then** клиент получает все обновления без пропусков или задержек >200мс

---

### User Story 6 - User Data Stream через WebSocket (Priority: P2)

Трейдер хочет получать уведомления об изменениях своих ордеров и баланса в реальном времени без polling.

**Why this priority**: Улучшает UX для активных трейдеров, но базовая функциональность работает через REST API.

**Independent Test**: Можно протестировать подключившись к `/ws/user` с авторизацией и получая события о своих ордерах. Доставляет ценность - мгновенные уведомления о состоянии торговли.

**Acceptance Scenarios**:

1. **Given** пользователь авторизован и подключен к `/ws/user`, **When** его ордер исполнен, **Then** получает событие "executionReport" с деталями исполнения
2. **Given** баланс изменился после трейда, **When** происходит изменение, **Then** получает событие "outboundAccountPosition" с новым балансом
3. **Given** соединение требует обновления listen key, **When** listen key истекает через 60 минут, **Then** сервер автоматически обновляет ключ

---

### Edge Cases

- **Что происходит при rate limit от Binance?** Сервер должен возвращать HTTP 429 с Retry-After header и автоматически применять exponential backoff для повторных запросов
- **Как обрабатывается потеря WebSocket соединения?** Клиент должен автоматически переподключаться с exponential backoff (1s, 2s, 4s, ..., max 30s), восстанавливая все подписки
- **Что если Binance credentials невалидны?** При первом запросе к authenticated endpoint возвращается HTTP 401 с описанием проблемы ("Invalid API key" или "Invalid signature")
- **Как обрабатывается таймаут Binance API?** Если Binance не отвечает в течение 10 секунд, возвращается HTTP 504 Gateway Timeout с рекомендацией повторить запрос
- **Что при одновременных запросах к одному ресурсу?** Все запросы обрабатываются конкурентно без блокировок, каждый получает актуальное состояние на момент запроса
- **Как обрабатываются невалидные WebSocket сообщения?** Сервер отправляет error frame с описанием проблемы и продолжает работу без разрыва соединения
- **Что если превышен лимит WebSocket подключений?** Новые подключения отклоняются с HTTP 503 и сообщением "Maximum WebSocket connections reached"

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система ДОЛЖНА предоставлять REST API endpoints для получения рыночных данных (цены, свечи, стакан, trades)
- **FR-002**: Система ДОЛЖНА предоставлять REST API endpoints для управления ордерами (создание, отмена, получение статуса, история)
- **FR-003**: Система ДОЛЖНА предоставлять REST API endpoints для получения информации об аккаунте (баланс, позиции, история трейдов)
- **FR-004**: Система ДОЛЖНА предоставлять WebSocket API для реалтайм обновлений цен (ticker stream)
- **FR-005**: Система ДОЛЖНА предоставлять WebSocket API для реалтайм обновлений стакана ордеров (depth stream)
- **FR-006**: Система ДОЛЖНА предоставлять WebSocket API для реалтайм уведомлений о пользовательских событиях (user data stream)
- **FR-007**: Система ДОЛЖНА требовать авторизацию через Bearer token для всех REST API запросов
- **FR-008**: Система ДОЛЖНА требовать авторизацию для WebSocket подключений к приватным streams (user data)
- **FR-009**: Система ДОЛЖНА использовать Binance API credentials для аутентифицированных запросов к Binance
- **FR-010**: Система ДОЛЖНА автоматически применять rate limiting и exponential backoff при ошибках от Binance
- **FR-011**: Система ДОЛЖНА возвращать понятные HTTP статус коды (200, 400, 401, 403, 429, 500, 504) для всех REST запросов
- **FR-012**: Система ДОЛЖНА возвращать JSON responses для всех REST API endpoints
- **FR-013**: Система ДОЛЖНА отправлять JSON сообщения через WebSocket для всех streams
- **FR-014**: Система ДОЛЖНА поддерживать CORS для возможности вызова API из браузера
- **FR-015**: Система ДОЛЖНА логировать все входящие REST запросы и WebSocket подключения без раскрытия чувствительных данных
- **FR-016**: Система ДОЛЖНА автоматически восстанавливать WebSocket соединения с Binance при разрыве
- **FR-017**: Система ДОЛЖНА поддерживать конкурентную обработку множественных HTTP запросов
- **FR-018**: Система ДОЛЖНА валидировать все входные параметры перед отправкой запросов к Binance
- **FR-019**: Система ДОЛЖНА возвращать timestamp и request ID в каждом REST API response для трейсинга
- **FR-020**: Система ДОЛЖНА предоставлять health check endpoint для мониторинга статуса

### Key Entities

- **Market Data**: Рыночные данные включая текущие цены, OHLCV свечи, объемы торгов, 24h статистику
- **Order Book**: Стакан ордеров с bid/ask уровнями, объемами, количеством ордеров на каждом уровне
- **Order**: Торговый ордер с типом (limit/market), стороной (buy/sell), символом, ценой, объемом, статусом
- **Account**: Информация об аккаунте включая балансы всех активов (доступные и заблокированные средства)
- **Position**: Открытая позиция с символом, размером, средней ценой входа, текущим P&L, маржой
- **Trade**: Исполненный трейд с ценой, объемом, стороной, временем исполнения, комиссией
- **Server Token**: JWT или API key для аутентификации запросов к серверу MCP
- **Binance Credentials**: API key и Secret key для подписи запросов к Binance API

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Пользователи могут получить текущую цену любого торгового инструмента через REST API за время < 1 секунды
- **SC-002**: Система поддерживает минимум 100 одновременных REST API запросов без деградации производительности (response time < 2 секунд)
- **SC-003**: Система поддерживает минимум 50 одновременных WebSocket подключений
- **SC-004**: WebSocket обновления цен доставляются клиентам с задержкой < 500 мс от момента обновления на Binance
- **SC-005**: Пользователи могут успешно создать, проверить статус и отменить ордер через REST API за < 5 секунд общего времени
- **SC-006**: При потере соединения с Binance система автоматически восстанавливает подключение в течение < 30 секунд
- **SC-007**: 95% всех REST API запросов завершаются успешно (HTTP 2xx) в нормальных условиях
- **SC-008**: Система корректно обрабатывает rate limits от Binance без потери данных для пользователя
- **SC-009**: API документация позволяет разработчику интегрироваться с системой за < 30 минут
- **SC-010**: Система работает непрерывно 24/7 с uptime > 99.5%

## Assumptions

- Пользователи имеют базовое понимание криптовалютной торговли и знают что такое символы (BTCUSDT), типы ордеров, стакан
- Сервер работает на стабильном интернет соединении с низким latency к Binance API (<100ms)
- Binance API credentials предоставлены администратором сервера через environment variables или конфигурационный файл
- Используется Binance Spot API (не Futures), если не указано иное
- Rate limits Binance соблюдаются на уровне server application, клиенты могут делать запросы без собственного rate limiting
- Server tokens (для авторизации клиентов) генерируются и управляются отдельной системой или предоставляются в конфигурации
- WebSocket reconnect логика на стороне клиента опциональна, сервер сам поддерживает соединения с Binance
- Все timestamps в миллисекундах (Unix epoch format) как в Binance API
- JSON является единственным форматом обмена данными (не XML, не protobuf)

## Dependencies

- Существующий MCP Binance Server (feature 001-mcp-server-foundation) - используем его Binance API client и credential management
- Binance API доступен и работает стабильно
- Система имеет валидные Binance API credentials с необходимыми permissions
- HTTP server framework (предполагается использование зрелого решения)
- WebSocket library с поддержкой автоматического reconnect

## Out of Scope

- Управление Binance API credentials через UI или API (настраивается через конфигурацию)
- Авторизация и регистрация пользователей сервера (предполагается существующая система или простые токены)
- Персистентное хранение исторических данных (все данные запрашиваются у Binance в реальном времени)
- Алгоритмическая торговля или стратегии (сервер только предоставляет доступ к API)
- Графики и визуализация (это задача клиентских приложений)
- Futures, Margin, Options API (только Spot trading)
- Интеграция с другими биржами кроме Binance
- Rate limiting на стороне клиентов (сервер обрабатывает Binance rate limits)
- Мониторинг и алертинг (предполагается внешняя система мониторинга)
