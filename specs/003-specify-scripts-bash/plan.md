# Implementation Plan: HTTP REST API + WebSocket для Binance

**Branch**: `003-http-websocket-api` | **Date**: 2025-10-16 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/003-specify-scripts-bash/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command.

## Summary

Add HTTP REST API and WebSocket transport layer to MCP Binance Server, enabling direct HTTP access to Binance market data and trading functionality. Implements hybrid architecture: REST endpoints for request/response operations (market data, orders, account) and WebSocket streams for real-time data (prices, order book, user events). Includes two-level authentication (server Bearer token + Binance API credentials), rate limiting, CORS support, and automatic connection recovery.

## Technical Context

**Language/Version**: Rust 1.90+ (Edition 2024)
**Primary Dependencies**:
- axum 0.8+ (HTTP server framework - chosen for type safety, tower middleware integration)
- tokio 1.48+ (already in project, async runtime)
- tokio-tungstenite 0.26+ (WebSocket client for Binance streams)
- tower 0.5+ (middleware: rate limiting, auth, CORS, tracing)
- tower-http 0.6+ (HTTP-specific middleware: CORS, compression, tracing)

**Storage**: N/A (all data fetched from Binance in real-time, no persistence)
**Testing**: cargo test (unit), integration tests for REST/WebSocket endpoints
**Target Platform**: Linux/macOS server (same as existing MCP server)
**Project Type**: Single project (web server added to existing Rust binary)
**Performance Goals**:
- REST API: <1s response time (SC-001)
- 100 concurrent REST requests without degradation (SC-002)
- 50 concurrent WebSocket connections (SC-003)
- WebSocket latency <500ms from Binance (SC-004)

**Constraints**:
- Must respect Binance rate limits (SC-008)
- 95% success rate for REST API (SC-007)
- 99.5% uptime (SC-010)
- Memory <50MB per existing foundation benchmark

**Scale/Scope**:
- 6 user stories (3 P1 REST APIs, 3 P2 WebSocket streams)
- 20 functional requirements
- ~15-20 REST endpoints (market data, orders, account)
- 3 WebSocket stream types (ticker, depth, user data)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### I. Security-First (NON-NEGOTIABLE)

| Check | Status | Evidence |
|-------|--------|----------|
| No API keys in code | ✅ PASS | FR-009: Uses existing Binance credentials from env (feature 001) |
| HMAC signature validation | ✅ PASS | Reuses existing `BinanceClient` which implements HMAC signing |
| Rate limiting with backoff | ✅ PASS | FR-010: Exponential backoff, reuses existing client retry logic |
| Input validation | ✅ PASS | FR-018: Validate params before Binance API calls |
| No sensitive data in errors | ✅ PASS | FR-015: Mask credentials in logs, FR-011: Standard HTTP codes |
| Security audit passing | ✅ PASS | `cargo audit` runs in pre-commit (existing) |

**Gate**: ✅ **PASS** - All security requirements satisfied

### II. Auto-Generation Priority

| Check | Status | Evidence |
|-------|--------|----------|
| OpenAPI/schema-driven | ⚠️ PARTIAL | OpenAPI spec will be manually written (see Complexity Tracking) |
| No manual API edits | ✅ PASS | axum routes are manual but type-safe, handlers call existing client |
| Code generation documented | ⚠️ WAIVED | OpenAPI spec is output, not input (see research.md Phase 0) |

**Gate**: ⚠️ **CONDITIONAL PASS** - See Complexity Tracking for justification

### III. Modular Architecture

| Check | Status | Evidence |
|-------|--------|----------|
| Feature-gated modules | ✅ PASS | Add `http-api` and `websocket` Cargo features (optional) |
| Default features preserved | ✅ PASS | Existing `spot` + `server` + `transport-stdio` remain default |
| Independent compilation | ✅ PASS | HTTP/WS features optional, stdio MCP works without them |
| Dynamic tool registration | N/A | Not applicable - HTTP transport doesn't use MCP tools |

**Gate**: ✅ **PASS** - Maintains modular architecture

### IV. Type Safety & Contract Enforcement

| Check | Status | Evidence |
|-------|--------|----------|
| Rust type enforcement | ✅ PASS | Reuse existing types from feature 001 (OrderStatus, etc.) |
| JSON Schema generation | ✅ PASS | OpenAPI 3.1 spec with schemas in contracts/ |
| No silent deser failures | ✅ PASS | axum::Json<T> returns 400 on invalid JSON |
| Typed timestamps | ✅ PASS | Reuse existing timestamp wrappers from feature 001 |
| Filter validation | ✅ PASS | Binance client already validates filters |

**Gate**: ✅ **PASS** - Full type safety maintained

### V. MCP Protocol Compliance (NON-NEGOTIABLE)

| Check | Status | Evidence |
|-------|--------|----------|
| Full MCP lifecycle | N/A | HTTP transport doesn't use MCP protocol (parallel interface) |
| tools/list accuracy | N/A | Not applicable to HTTP REST API |
| Stdio transport support | ✅ PASS | Existing stdio MCP remains functional |
| HTTP transport support | ✅ PASS | This feature adds HTTP (non-MCP) transport |

**Gate**: ✅ **PASS** - MCP stdio preserved, HTTP is additional transport

**Note**: This feature adds non-MCP HTTP/WebSocket transport alongside existing MCP stdio. The MCP server continues to work via stdio, and HTTP API is a separate interface to the same underlying Binance client.

### VI. Async-First Design

| Check | Status | Evidence |
|-------|--------|----------|
| Tokio async runtime | ✅ PASS | axum is tokio-native, WebSocket uses tokio channels |
| No blocking in async | ✅ PASS | All I/O async (axum, tokio-tungstenite, reqwest) |
| Async Binance calls | ✅ PASS | Reuses existing async BinanceClient |
| WebSocket async channels | ✅ PASS | tokio::sync::broadcast for WebSocket fanout |
| Rate limit semaphores | ✅ PASS | tower::limit::RateLimitLayer for concurrency control |

**Gate**: ✅ **PASS** - Fully async architecture

### VII. Machine-Optimized Development

| Check | Status | Evidence |
|-------|--------|----------|
| Added via /speckit.specify | ✅ PASS | This feature created via spec → plan → tasks workflow |
| Machine-readable spec | ✅ PASS | spec.md has Given/When/Then, FR-###, SC-### |
| Tasks map to requirements | ⏳ PENDING | tasks.md will be generated in Phase 2 (/speckit.tasks) |
| Tests-first when required | ⏳ PENDING | Will determine in tasks.md generation |
| No [NEEDS CLARIFICATION] | ✅ PASS | spec.md has 0 clarification markers |

**Gate**: ✅ **PASS** - Follows machine-optimized workflow

---

**Overall Constitution Check**: ✅ **6/7 PASS**, 1 conditional (Auto-Generation)

**Action Required**: Document OpenAPI manual generation justification in Complexity Tracking before Phase 0.

## Project Structure

### Documentation (this feature)

```
specs/003-http-websocket-api/
├── plan.md              # This file
├── research.md          # Phase 0: Technology decisions
├── data-model.md        # Phase 1: API request/response models
├── quickstart.md        # Phase 1: cURL examples for testing
├── contracts/           # Phase 1: OpenAPI 3.1 specification
│   ├── openapi.yaml     # Full API spec
│   └── schemas/         # Shared JSON schemas
└── tasks.md             # Phase 2: /speckit.tasks output (NOT in this plan)
```

### Source Code (repository root)

```
src/
├── http/                    # NEW: HTTP server module
│   ├── mod.rs              # Module root, axum app setup
│   ├── routes/             # REST API route handlers
│   │   ├── mod.rs
│   │   ├── market_data.rs  # GET /api/v1/ticker/price, /klines, etc.
│   │   ├── orders.rs       # POST/DELETE/GET /api/v1/order
│   │   └── account.rs      # GET /api/v1/account, /positions
│   ├── middleware/         # Tower middleware
│   │   ├── mod.rs
│   │   ├── auth.rs         # Bearer token validation
│   │   ├── rate_limit.rs   # Rate limiting layer
│   │   └── cors.rs         # CORS configuration
│   └── websocket/          # WebSocket handler module
│       ├── mod.rs
│       ├── ticker.rs       # /ws/ticker/:symbol stream
│       ├── depth.rs        # /ws/depth/:symbol stream
│       └── user_data.rs    # /ws/user authenticated stream
│
├── binance/                # EXISTING: Reused for HTTP/WS
│   ├── client.rs           # BinanceClient with get_*, post_*, delete_*
│   └── websocket.rs        # NEW: Binance WebSocket client wrapper
│
├── config/                 # EXISTING
│   ├── credentials.rs      # Reused for Binance auth
│   └── http.rs             # NEW: HTTP server config (port, CORS, tokens)
│
├── server/                 # EXISTING: MCP server (stdio)
│   └── mod.rs              # BinanceServer for MCP protocol
│
├── tools/                  # EXISTING: MCP tools
│   └── get_server_time.rs  # Not used by HTTP API
│
├── error.rs                # EXISTING: Extend with HTTP error conversions
└── main.rs                 # UPDATED: Add --http flag to start HTTP server

Cargo.toml                  # UPDATED: Add http-api, websocket features
```

**Structure Decision**: Single project with feature gates. HTTP server is an optional feature (`http-api`) that can be enabled alongside or instead of the stdio MCP server. This maintains the existing modular architecture (Constitution III) while adding new transport options.

**Key Decisions**:
1. **Separate http/ module**: HTTP concerns isolated from MCP protocol logic
2. **Reuse binance/client.rs**: HTTP routes call the same BinanceClient as MCP tools
3. **Feature gates**: `--features http-api` enables HTTP, `--features websocket` enables WS
4. **main.rs dispatch**: `--http` flag starts axum server, default starts stdio MCP server

## Complexity Tracking

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| **Manual OpenAPI spec** (violates Auto-Generation II) | OpenAPI is output artifact documenting the API, not an input for code generation. The API is hand-written using axum's type-safe routing. | Generating Rust code from OpenAPI would require: (1) choosing an OpenAPI → Rust codegen tool (openapi-generator, progenitor), (2) writing OpenAPI spec first, (3) maintaining bidirectional sync. This adds complexity without value since axum already provides type-safe routing. OpenAPI spec serves as documentation output, generated manually or via tools like `utoipa`. |
| **No blocking operations** (potential in WebSocket reconnect) | WebSocket reconnection logic may need brief synchronous waits for exponential backoff. | Could use async sleep (tokio::time::sleep), but tokio-tungstenite's reconnect patterns may involve sync primitives. Will verify in Phase 0 research and use async timers if feasible. |

**Justification**: Manual OpenAPI authoring is acceptable when the API is the source of truth (Constitution II allows "glue logic" to be manual). The spec documents hand-written axum routes rather than generating them. This follows industry practice for type-safe Rust HTTP frameworks.

## Phase 0: Research & Technology Selection

**Goal**: Resolve all technical unknowns and document architecture decisions.

### Research Tasks

1. **HTTP Framework Selection** (axum vs actix-web vs warp)
   - Compare type safety, middleware ecosystem, community support
   - Decision: axum (tower middleware, serde integration, active development)
   - Output: research.md § HTTP Framework

2. **WebSocket Architecture** (tokio-tungstenite vs async-tungstenite)
   - Binance WebSocket client patterns
   - Fan-out strategy (tokio::sync::broadcast vs mpsc)
   - Reconnection and subscription management
   - Output: research.md § WebSocket Design

3. **Authentication Strategy** (JWT vs API keys vs custom tokens)
   - Bearer token generation and validation
   - Integration with existing Binance credentials
   - Token storage and rotation
   - Output: research.md § Authentication

4. **Rate Limiting Implementation** (tower::limit vs governor)
   - Request-level vs user-level rate limits
   - Binance weight tracking integration
   - Memory overhead for concurrent connections
   - Output: research.md § Rate Limiting

5. **OpenAPI Documentation** (utoipa vs manual YAML)
   - Auto-generation from axum routes vs manual authoring
   - JSON Schema validation integration
   - Documentation hosting (swagger-ui)
   - Output: research.md § API Documentation

6. **Testing Strategy**
   - Integration tests for REST endpoints (using reqwest client)
   - WebSocket test clients (tungstenite)
   - Mock Binance API for CI (wiremock or mockito)
   - Output: research.md § Testing Approach

### Research Output

**File**: `specs/003-http-websocket-api/research.md`

**Format**:
```markdown
# Research: HTTP REST API + WebSocket

## HTTP Framework Decision

**Decision**: axum 0.8.1
**Rationale**:
- Type-safe routing via tower::Service
- Best-in-class middleware via tower
- Excellent serde/JSON integration
- Active community, frequent updates
- Performance competitive with actix-web

**Alternatives Considered**:
- actix-web: More mature but moving to maintenance mode
- warp: Less ergonomic, smaller ecosystem

**References**:
- axum docs: https://docs.rs/axum/latest/axum/
- tower middleware: https://docs.rs/tower/latest/tower/

[... continue for each research task ...]
```

## Phase 1: Design & Contracts

**Prerequisites**: research.md complete

### 1.1 Data Model Design

**File**: `specs/003-http-websocket-api/data-model.md`

**Content**: Extract entities from spec.md Key Entities section:

```markdown
# Data Models: HTTP REST API + WebSocket

## REST API Models

### MarketData
- symbol: String (e.g., "BTCUSDT")
- price: Decimal
- timestamp: i64 (milliseconds)
- 24h_volume: Decimal
- 24h_high: Decimal
- 24h_low: Decimal

**Source**: Binance GET /api/v3/ticker/24hr
**Validation**: Symbol must match Binance trading pairs

### Kline (Candlestick)
- open_time: i64
- open: Decimal
- high: Decimal
- low: Decimal
- close: Decimal
- volume: Decimal
- close_time: i64
- quote_volume: Decimal
- trades: u64
- taker_buy_volume: Decimal
- taker_buy_quote_volume: Decimal

**Source**: Binance GET /api/v3/klines
**Validation**: Interval enum (1m, 5m, 15m, 1h, 4h, 1d, 1w, 1M)

[... continue for Order, Account, Position, Trade entities ...]

## WebSocket Stream Models

### TickerUpdate
- event_type: "24hrTicker"
- event_time: i64
- symbol: String
- price: Decimal
- price_change: Decimal
- price_change_percent: Decimal

[... continue for DepthUpdate, UserDataUpdate ...]
```

### 1.2 API Contracts

**Directory**: `specs/003-http-websocket-api/contracts/`

**Files**:
- `openapi.yaml` - Full OpenAPI 3.1 specification
- `schemas/` - Shared JSON schemas

**Content** (`openapi.yaml` structure):

```yaml
openapi: 3.1.0
info:
  title: Binance MCP HTTP API
  version: 1.0.0
  description: REST API and WebSocket interface for Binance trading

servers:
  - url: http://localhost:3000
    description: Local development

security:
  - bearerAuth: []

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    MarketData:
      type: object
      required: [symbol, price, timestamp]
      properties:
        symbol: {type: string, example: "BTCUSDT"}
        price: {type: string, example: "45000.50"}
        timestamp: {type: integer, format: int64}

    [... all models from data-model.md ...]

paths:
  /api/v1/ticker/price:
    get:
      summary: Get current price
      operationId: getTickerPrice
      parameters:
        - name: symbol
          in: query
          required: true
          schema: {type: string}
      responses:
        '200':
          description: Current price
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MarketData'
        '400':
          description: Invalid symbol
        '401':
          description: Unauthorized

  [... all 15-20 REST endpoints from FR-001, FR-002, FR-003 ...]
```

**WebSocket Protocol** (separate section in openapi.yaml):

```yaml
# WebSocket streams are not part of OpenAPI spec, document separately

x-websocket-streams:
  /ws/ticker/{symbol}:
    description: Real-time ticker updates
    subscribe:
      method: SUBSCRIBE
      params: ["@ticker"]
    message_schema:
      $ref: '#/components/schemas/TickerUpdate'

  /ws/depth/{symbol}:
    description: Order book depth updates
    subscribe:
      method: SUBSCRIBE
      params: ["@depth"]
    message_schema:
      $ref: '#/components/schemas/DepthUpdate'

  /ws/user:
    description: User data stream
    authentication: Required (listen key)
    message_schema:
      oneOf:
        - $ref: '#/components/schemas/ExecutionReport'
        - $ref: '#/components/schemas/AccountUpdate'
```

### 1.3 Quickstart Guide

**File**: `specs/003-http-websocket-api/quickstart.md`

**Content**: Executable examples for each user story:

```markdown
# Quickstart: HTTP REST API + WebSocket

## Prerequisites

```bash
# Build with HTTP feature
cargo build --release --features http-api,websocket

# Start HTTP server
export BINANCE_API_KEY="your_key"
export BINANCE_SECRET_KEY="your_secret"
export SERVER_TOKEN="test_bearer_token"
./target/release/mcp-binance-server --http --port 3000
```

## User Story 1: Get Market Data (REST API)

### Get Current Price
```bash
curl -H "Authorization: Bearer test_bearer_token" \
  'http://localhost:3000/api/v1/ticker/price?symbol=BTCUSDT'

# Expected Response:
# {"symbol":"BTCUSDT","price":"45000.50","timestamp":1609459200000}
```

### Get Historical Candles
```bash
curl -H "Authorization: Bearer test_bearer_token" \
  'http://localhost:3000/api/v1/klines?symbol=BTCUSDT&interval=1h&limit=100'

# Expected: Array of 100 OHLCV candles
```

[... continue for all 6 user stories with curl/wscat examples ...]

## User Story 4: Real-Time Prices (WebSocket)

### Connect to Ticker Stream
```bash
# Install wscat if needed: npm install -g wscat
wscat -c 'ws://localhost:3000/ws/ticker/btcusdt' \
  -H "Authorization: Bearer test_bearer_token"

# Expected: JSON messages every 100-1000ms with price updates
# {"e":"24hrTicker","E":1609459200000,"s":"BTCUSDT","c":"45000.50",...}
```

[... full examples matching acceptance scenarios from spec.md ...]
```

### 1.4 Update Agent Context

**Script**: `.specify/scripts/bash/update-agent-context.sh claude`

**Action**: Update `CLAUDE.md` with new technologies:

```markdown
## Active Technologies
- Rust 1.90+ (Edition 2024)
- axum 0.8+ - HTTP server framework
- tokio 1.48+ - Async runtime
- tokio-tungstenite 0.26+ - WebSocket client
- tower 0.5+ - Middleware (rate limit, auth, CORS)
- tower-http 0.6+ - HTTP middleware
- ... (existing dependencies remain)

## Commands
cargo build --features http-api,websocket
cargo run -- --http --port 3000
cargo test --features http-api
```

## Constitution Re-Check (Post-Design)

**Status After Phase 1**: ✅ **ALL GATES PASS**

**Changes from Initial Check**:
- research.md confirms axum's type safety satisfies Constitution IV
- OpenAPI manual authoring documented in Complexity Tracking (acceptable per Constitution II)
- WebSocket reconnect will use tokio::time::sleep (no blocking) - Constitution VI satisfied

**Final Verdict**: Ready for Phase 2 (tasks.md generation via `/speckit.tasks`)

## Next Steps

1. ✅ **Complete**: Phase 0 research.md (technology decisions)
2. ✅ **Complete**: Phase 1 data-model.md, contracts/, quickstart.md
3. ✅ **Complete**: Agent context updated (CLAUDE.md)
4. ⏳ **Pending**: Run `/speckit.tasks` to generate implementation tasks
5. ⏳ **Pending**: Run `/speckit.implement` to execute tasks

**Command to Continue**:
```bash
/speckit.tasks
```

This will generate `specs/003-http-websocket-api/tasks.md` with dependency-ordered implementation steps.
